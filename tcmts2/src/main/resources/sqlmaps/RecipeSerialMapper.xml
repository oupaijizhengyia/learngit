<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tangu.tcmts.dao.RecipeSerialMapper">
  <resultMap id="BaseResultMap" type="com.tangu.tcmts.po.RecipeSerial">
  </resultMap>
  <sql id="Base_Column_List">
    recipe_serial, recipe_id
  </sql>
  <select id="selectByPrimaryKey" parameterType="com.tangu.tcmts.po.RecipeSerial" resultType="com.tangu.tcmts.po.RecipeSerial">
    select 
    rs.recipe_id, rs.recipe_serial, rp.modify_time, r.shipping_state, 
		sss.state_name AS shippingStateName,
		r.sys_recipe_code,
		r.shelves_code, r.recipient_name,rp.delivery_time,rp.end_boil_time,rp.start_boil_time
		,rp.make_time,rp.check_time,rp.start_soak_time,rp.collect_time,rp.package_time
		,rp.start_concentrate_time,rp.end_concentrate_time,rp.end_subside_time
		,rp.frist_boil_time,rp.after_boil_time,rp.check_bill_time
    from recipe_serial rs
    left join recipe r on r.id = rs.recipe_id
    left join recipe_proccess rp on rp.recipe_id = rs.recipe_id
	LEFT JOIN sys_shipping_state sss on r.shipping_state = sss.state_id
    where rs.recipe_serial = #{recipeSerial,jdbcType=VARCHAR}
  </select>
  <select id="selectByRecipeSerial" parameterType="com.tangu.tcmts.po.RecipeSerial" resultType="com.tangu.tcmts.po.RecipeSerial">
    
SELECT 
    r.`id` AS  recipe_id, r.recipe_serial, rp.modify_time, r.shipping_state, 
		sss.state_name AS shippingStateName,
		r.sys_recipe_code,
		r.shelves_code, r.recipient_name,rp.delivery_time,rp.end_boil_time,rp.start_boil_time
		,rp.make_time,rp.check_time,rp.start_soak_time,rp.collect_time,rp.package_time
		,rp.start_concentrate_time,rp.end_concentrate_time,rp.end_subside_time
		,rp.frist_boil_time,rp.after_boil_time,rp.check_bill_time
    FROM  recipe r
    LEFT JOIN recipe_proccess rp ON rp.recipe_id = r.`id`
	LEFT JOIN sys_shipping_state sss ON r.shipping_state = sss.state_id
    WHERE r.recipe_serial = #{recipeSerial,jdbcType=VARCHAR}
  </select>
  <select id="listTakeMedicine" parameterType="com.tangu.tcmts.po.RecipeSerial" resultType="com.tangu.tcmts.po.RecipeSerial">
  	SELECT
		r.invoice_code, r.outpatient_num, r.recipient_name, r.take_time,
		r.shipping_state, r.shelves_code, r.sys_recipe_code,
		r.recipe_serial,	
		r.recipient_tel, 
		rp.delivery_time, rp.shelve_time, 
		sss.state_name AS shippingStateName,
		r.id as recipe_id
	FROM
		recipe r
		inner join recipe_proccess rp on r.id = rp.recipe_id
		LEFT JOIN sys_shipping_state sss on r.shipping_state = sss.state_id
  	<where>
  	r.belong = 1
        <if test="startTime != null or endTime != null">
          AND rp.shelve_time between #{startTime}  and  DATE_ADD(#{endTime},INTERVAL 1 DAY)
        </if>
  		<if test="shippingState != null">
  			<if test="shippingState ==95">
	  		  AND r.shipping_state = #{shippingState}
  			</if>
  			<if test="shippingState ==100">
	  		  AND r.shipping_state &gt;= #{shippingState}
  			</if>
      	</if>
      	<if test="shippingState == null">
          AND r.shipping_state>=95 AND r.shipping_state &lt; 999
      	</if>
      	<if test="invoiceCode != null and invoiceCode != ''">
          AND r.invoice_code = #{invoiceCode}
        </if>
      	<if test="recipientName != null and recipientName != ''">
          AND r.recipient_name LIKE CONCAT('%',#{recipientName},'%')
        </if>
        <if test="outpatientNum != null and outpatientNum != ''">
          AND r.outpatient_num = #{outpatientNum}
        </if>
        <if test="shelvesCode != null and shelvesCode != ''">
          AND r.shelves_code LIKE CONCAT('%',#{shelvesCode},'%')
        </if>
  	</where>
      ORDER BY rp.shelve_time
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String">
    delete from recipe_serial
    where recipe_serial = #{recipeSerial,jdbcType=VARCHAR}
  </delete>
  <insert id="insertSelective" parameterType="com.tangu.tcmts.po.RecipeSerial">
    insert into recipe_serial
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="recipeSerial != null">
        recipe_serial,
      </if>
      <if test="recipeId != null">
        recipe_id,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="recipeSerial != null">
        #{recipeSerial,jdbcType=VARCHAR},
      </if>
      <if test="recipeId != null">
        #{recipeId,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.tangu.tcmts.po.RecipeSerial">
    update recipe_serial
    <set>
      <if test="recipeId != null">
        recipe_id = #{recipeId,jdbcType=INTEGER},
      </if>
    </set>
    where recipe_serial = #{recipeSerial,jdbcType=VARCHAR}
  </update>
</mapper>